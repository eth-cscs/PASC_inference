

# MINLIN HOST EXECUTABLE
#add_executable(pascinference_host pascinference.cpp)
#target_link_libraries(pascinference_host mkl_core mkl_gnu_thread mkl_rt boost_program_options)
#set_property(
#	TARGET pascinference_host
#	APPEND
#	PROPERTY INCLUDE_DIRECTORIES
#	${MINLIN_INCLUDE})
#set_target_properties(pascinference_host PROPERTIES
#	OUTPUT_NAME pascinference_host
#	COMPILE_DEFINITIONS "${MINLIN_HOST_DEFS}"
#	)

# MINLIN DEVICE EXECUTABLE


set(MINLIN_DEVICE_DEFS # we use -D here because this isn't added automatically
	-DTHRUST_HOST_SYSTEM=THRUST_HOST_SYSTEM_OMP
	-DTHRUST_DEVICE_SYSTEM=THRUST_DEVICE_SYSTEM_CUDA
	${LIBRARY_DEFS}
	-DUSE_MINLIN)



#decide which test to compile
option(TEST_ALGEBRA "TEST_ALGEBRA" OFF)
option(TEST_GIVENMATRIX "TEST_GIVENMATRIX" OFF)
option(TEST_LAPLACEMATRIX "TEST_LAPLACEMATRIX" OFF)
option(TEST_CG "TEST_CG" OFF)
option(TEST_SPGQP "TEST_SPGQP" OFF)
option(TEST_KMEANS "TEST_KMEANS" ON)


# -------------------- TEST ALGEBRA ------------------
if(${TEST_ALGEBRA})
	# add main executable file
	cuda_add_executable(test_algebra test_algebra.cu
		OPTIONS "${MINLIN_DEVICE_DEFS} -arch=sm_35 --compiler-options \"${CUDA_CXX_FLAGS}\""
		DEBUG ${CMAKE_CXX_FLAGS_DEBUG})
	
	# link external libraries	
	target_link_libraries(test_algebra libpascinference mkl_core mkl_gnu_thread mkl_rt boost_program_options cublas ${PETSC_LIBRARIES})

	# set the name of output file
	set_target_properties(test_algebra PROPERTIES
		OUTPUT_NAME test_algebra
		)
endif()


# -------------------- TEST GIVEN MATRIX ------------------
if(${TEST_GIVENMATRIX})
	# add main executable file
	cuda_add_executable(test_filecrsmatrix test_filecrsmatrix.cu
		OPTIONS "${MINLIN_DEVICE_DEFS} -arch=sm_35 --compiler-options \"${CUDA_CXX_FLAGS}\""
		DEBUG ${CMAKE_CXX_FLAGS_DEBUG})
	
	# link external libraries	
	target_link_libraries(test_filecrsmatrix libpascinference mkl_core mkl_gnu_thread mkl_rt boost_program_options cublas ${PETSC_LIBRARIES})

	# set the name of output file
	set_target_properties(test_filecrsmatrix PROPERTIES
		OUTPUT_NAME test_filecrsmatrix
		)
endif()


# -------------------- TEST LAPLACE MATRIX ------------------
if(${TEST_LAPLACEMATRIX})
	# add main executable file
	cuda_add_executable(test_laplacematrix test_laplacematrix.cu
		OPTIONS "${MINLIN_DEVICE_DEFS} -arch=sm_35 --compiler-options \"${CUDA_CXX_FLAGS}\""
		DEBUG ${CMAKE_CXX_FLAGS_DEBUG})
	
	# link external libraries	
	target_link_libraries(test_laplacematrix libpascinference mkl_core mkl_gnu_thread mkl_rt boost_program_options cublas ${PETSC_LIBRARIES})

	# set the name of output file
	set_target_properties(test_laplacematrix PROPERTIES
		OUTPUT_NAME test_laplacematrix
		)
endif()



# -------------------- TEST CG ------------------
if(${TEST_CG})
	# add main executable file
	cuda_add_executable(test_cg test_cg.cu
		OPTIONS "${MINLIN_DEVICE_DEFS} -arch=sm_35 --compiler-options \"${CUDA_CXX_FLAGS}\""
		DEBUG ${CMAKE_CXX_FLAGS_DEBUG})
	
	# link external libraries	
	target_link_libraries(test_cg libpascinference mkl_core mkl_gnu_thread mkl_rt boost_program_options cublas ${PETSC_LIBRARIES})

	# set the name of output file
	set_target_properties(test_cg PROPERTIES
		OUTPUT_NAME test_cg
	)
endif()


# -------------------- TEST SPGQP ------------------
if(${TEST_SPGQP})
	# add main executable file
	cuda_add_executable(test_spgqp test_spgqp.cu
		OPTIONS "${MINLIN_DEVICE_DEFS} -arch=sm_35 --compiler-options \"${CUDA_CXX_FLAGS}\""
		DEBUG ${CMAKE_CXX_FLAGS_DEBUG})
	
	# link external libraries	
	target_link_libraries(test_spgqp libpascinference mkl_core mkl_gnu_thread mkl_rt boost_program_options cublas ${PETSC_LIBRARIES})

	# set the name of output file
	set_target_properties(test_spgqp PROPERTIES
		OUTPUT_NAME test_spgqp
	)
endif()


# -------------------- TEST KMEANS ------------------
if(${TEST_KMEANS})
	# add main executable file
	cuda_add_executable(test_kmeans test_kmeans.cu
		OPTIONS "${MINLIN_DEVICE_DEFS} -arch=sm_35 --compiler-options \"${CUDA_CXX_FLAGS}\""
		DEBUG ${CMAKE_CXX_FLAGS_DEBUG})
	
	# link external libraries	
	target_link_libraries(test_kmeans libpascinference mkl_core mkl_gnu_thread mkl_rt boost_program_options cublas ${PETSC_LIBRARIES})

	# set the name of output file
	set_target_properties(test_kmeans PROPERTIES
		OUTPUT_NAME test_kmeans
	)
endif()
